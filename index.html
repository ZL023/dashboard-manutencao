<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Diagonal de Manutenção</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background: #f0f2f5; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; }
        header { background: #1a3a5a; color: white; padding: 20px; text-align: center; border-radius: 8px; margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .card { background: white; padding: 15px; border-radius: 8px; border-top: 5px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .chart-box { background: white; padding: 20px; margin-top: 20px; border-radius: 8px; height: 400px; }
        .error-msg { color: red; font-weight: bold; text-align: center; padding: 20px; background: #ffdada; border-radius: 8px; display: none; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Diagonal de Manutenção</h1>
        <div id="status-conexao">Conectando ao Google Sheets...</div>
    </header>

    <div id="erro-tela" class="error-msg"></div>

    <div id="cards-container" class="grid"></div>

    <div class="chart-box">
        <canvas id="graficoManutencao"></canvas>
    </div>
</div>

<script>
    // ==========================================
    // CONFIGURAÇÃO: COLE SEUS LINKS CSV AQUI
    var URL_FROTA = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTaUiXIXNFnZGpKFFXY3Agul8ZhqwFZsp6zeR_tzEI3iPDWc4gqMpJA2AmBSQXsSaaNiAyDQbxl54Gt/pub?gid=0&single=true&output=csv';
    var URL_HISTORICO = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTaUiXIXNFnZGpKFFXY3Agul8ZhqwFZsp6zeR_tzEI3iPDWc4gqMpJA2AmBSQXsSaaNiAyDQbxl54Gt/pub?gid=746527009&single=true&output=csv';
    // ==========================================

    function mostrarErro(msg) {
        const div = document.getElementById('erro-tela');
        div.style.display = 'block';
        div.innerHTML = "⚠️ " + msg;
        document.getElementById('status-conexao').innerText = "Falha na carga.";
    }

    function carregarDados() {
        if (URL_FROTA.includes('COLE_AQUI')) {
            mostrarErro("Você esqueceu de colar o link do CSV no código HTML!");
            return;
        }

        // Carregar Frota
        Papa.parse(URL_FROTA, {
            download: true,
            header: true,
            complete: function(results) {
                if (results.data.length > 0) {
                    renderizarCards(results.data);
                    document.getElementById('status-conexao').innerText = "Sincronizado: " + new Date().toLocaleTimeString();
                } else {
                    mostrarErro("Planilha de Frota vazia ou link inválido.");
                }
            },
            error: function(err) {
                mostrarErro("Bloqueio de segurança ou link offline. Tente abrir no Firefox ou subir para um site.");
            }
        });

        // Carregar Histórico
        Papa.parse(URL_HISTORICO, {
            download: true,
            header: true,
            complete: function(results) {
                desenharGrafico(results.data);
            }
        });
    }

    function renderizarCards(dados) {
        const lista = document.getElementById('cards-container');
        lista.innerHTML = '';
        dados.forEach(aviao => {
            if (!aviao.Matricula) return;
            const res = (parseFloat(aviao.ProximaInspecao) - parseFloat(aviao.HorasAtuais)).toFixed(1);
            lista.innerHTML += `
                <div class="card" style="border-top-color: ${res < 10 ? '#e74c3c' : '#27ae60'}">
                    <h3>${aviao.Matricula}</h3>
                    <p>Status: <b>${aviao.Status}</b></p>
                    <p>Restante: <b style="font-size:1.2em">${res}h</b></p>
                </div>
            `;
        });
    }

    function desenharGrafico(dados) {
        const ctx = document.getElementById('graficoManutencao').getContext('2d');
        const colunas = Object.keys(dados[0]).filter(k => k !== 'Data');
        
        const datasets = colunas.map((m, i) => ({
            label: m,
            data: dados.map(d => ({ x: new Date(d.Data), y: parseFloat(d[m]) })),
            borderColor: ['#1a3a5a', '#27ae60', '#f1c40f', '#e74c3c'][i % 4],
            tension: 0.3
        }));

        new Chart(ctx, {
            type: 'line',
            data: { datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { x: { type: 'time', time: { unit: 'day' } } }
            }
        });
    }

    window.onload = carregarDados;
</script>
</body>
</html>
