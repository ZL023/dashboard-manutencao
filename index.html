<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Diagonal de Manutenção</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background: #f0f2f5; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; }
        header { background: #1a3a5a; color: white; padding: 20px; text-align: center; border-radius: 8px; margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        
        /* CARD ESTILIZADO */
        .card { 
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            border-top: 6px solid #ccc; /* Cor padrão, será sobrescrita via JS */
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); 
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .card h3 { margin: 0 0 15px 0; color: #1a3a5a; font-size: 1.5em; }

        .card-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            color: #64748b;
            font-size: 0.9em;
            font-weight: 600;
        }

        .card-center {
            text-align: center;
            margin-top: auto;
        }

        .hours-text {
            font-size: 2.2em;
            font-weight: bold;
            color: #1e293b;
            line-height: 1;
        }
        .hours-label { font-size: 0.8em; color: #94a3b8; margin-bottom: 8px; display: block; }

        /* BARRA DE PROGRESSO */
        .progress-bg {
            background-color: #e2e8f0;
            height: 10px;
            border-radius: 10px;
            width: 100%;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 1s ease-in-out, background-color 1s ease;
        }

        .chart-box { background: white; padding: 20px; margin-top: 20px; border-radius: 8px; height: 400px; }
        .error-msg { color: red; font-weight: bold; text-align: center; padding: 20px; background: #ffdada; border-radius: 8px; display: none; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Diagonal de Manutenção</h1>
        <div id="status-conexao">Conectando ao Google Sheets...</div>
    </header>

    <div id="erro-tela" class="error-msg"></div>

    <div id="cards-container" class="grid"></div>

    <div class="chart-box">
        <canvas id="graficoManutencao"></canvas>
    </div>
</div>

<script>
    // ==========================================
    // LINKS CSV
    var URL_FROTA = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTaUiXIXNFnZGpKFFXY3Agul8ZhqwFZsp6zeR_tzEI3iPDWc4gqMpJA2AmBSQXsSaaNiAyDQbxl54Gt/pub?gid=0&single=true&output=csv';
    var URL_HISTORICO = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTaUiXIXNFnZGpKFFXY3Agul8ZhqwFZsp6zeR_tzEI3iPDWc4gqMpJA2AmBSQXsSaaNiAyDQbxl54Gt/pub?gid=746527009&single=true&output=csv';
    // ==========================================

    function mostrarErro(msg) {
        const div = document.getElementById('erro-tela');
        div.style.display = 'block';
        div.innerHTML = "⚠️ " + msg;
        document.getElementById('status-conexao').innerText = "Falha na carga.";
    }

    function carregarDados() {
        Papa.parse(URL_FROTA, {
            download: true, header: true,
            complete: function(resFrota) {
                Papa.parse(URL_HISTORICO, {
                    download: true, header: true,
                    complete: function(resHistorico) {
                        if (resFrota.data.length > 0 && resHistorico.data.length > 0) {
                            processarInterface(resFrota.data, resHistorico.data);
                            document.getElementById('status-conexao').innerText = "Atualizado: " + new Date().toLocaleTimeString();
                        } else { mostrarErro("Dados vazios."); }
                    },
                    error: function() { mostrarErro("Erro Histórico."); }
                });
            },
            error: function() { mostrarErro("Erro Frota."); }
        });
    }

    function processarInterface(frota, historico) {
        renderizarCards(frota, historico);
        desenharGrafico(historico);
    }

    function renderizarCards(frota, historico) {
        const lista = document.getElementById('cards-container');
        lista.innerHTML = '';

        const histValido = historico.filter(h => h.Data && h.Data.trim() !== '');
        const ultimoRegistro = histValido[histValido.length - 1];

        frota.forEach(aviao => {
            if (!aviao.Matricula) return;

            // 1. Pega horas restantes
            let horasRestantes = 0;
            if (ultimoRegistro && ultimoRegistro[aviao.Matricula] !== undefined) {
                horasRestantes = parseFloat(ultimoRegistro[aviao.Matricula]);
            } else {
                horasRestantes = parseFloat(aviao.ProximaInspecao) - parseFloat(aviao.HorasAtuais);
            }

            // 2. Define o TOTAL da inspeção para calcular a % (ex: tira "h" de "50h" -> vira 50)
            const tipoInspRaw = aviao.TipoInspecao ? aviao.TipoInspecao : '50h'; // Padrão 50h se vazio
            const totalInspecao = parseFloat(tipoInspRaw.replace(/\D/g,'')) || 50; // Extrai só números
            
            // 3. Calcula Porcentagem (Trava entre 0 e 100%)
            let porcentagem = (horasRestantes / totalInspecao) * 100;
            if (porcentagem > 100) porcentagem = 100;
            if (porcentagem < 0) porcentagem = 0;

            // 4. Calcula a Cor (HSL: 120 = Verde, 0 = Vermelho)
            // Multiplicamos por 1.2 para que 100% seja verde puro e 0% vermelho puro
            const corHue = Math.floor(porcentagem * 1.2); 
            const corFinal = `hsl(${corHue}, 70%, 45%)`;

            lista.innerHTML += `
                <div class="card" style="border-top-color: ${corFinal}">
                    <h3>${aviao.Matricula}</h3>
                    
                    <div class="card-info-row">
                        <span>Status: <b style="color:#333">${aviao.Status}</b></span>
                        <span>Tipo: <b style="color:#333">${tipoInspRaw}</b></span>
                    </div>

                    <div class="card-center">
                        <span class="hours-label">RESTANTE</span>
                        <div class="hours-text">${horasRestantes.toFixed(1)}h</div>
                        
                        <div class="progress-bg">
                            <div class="progress-fill" style="width: ${porcentagem}%; background-color: ${corFinal};"></div>
                        </div>
                    </div>
                </div>
            `;
        });
    }

    function desenharGrafico(dados) {
        const ctx = document.getElementById('graficoManutencao').getContext('2d');
        const colunas = Object.keys(dados[0]).filter(k => k !== 'Data');
        
        const datasets = colunas.map((m, i) => ({
            label: m,
            data: dados.map(d => ({ x: new Date(d.Data), y: parseFloat(d[m]) })),
            borderColor: ['#1a3a5a', '#27ae60', '#f1c40f', '#e74c3c'][i % 4],
            tension: 0.3
        }));

        new Chart(ctx, {
            type: 'line',
            data: { datasets },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { 
                    x: { type: 'time', time: { unit: 'day', displayFormats: { day: 'dd/MM' } }, title: { display: true, text: 'Data' } }, 
                    y: { beginAtZero: false, title: { display: true, text: 'Horas Restantes' } } 
                },
                plugins: { legend: { position: 'top' } }
            }
        });
    }

    window.onload = carregarDados;
</script>
</body>
</html>
