<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Diagonal de Manutenção</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background: #f0f2f5; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; }
        header { background: #1a3a5a; color: white; padding: 20px; text-align: center; border-radius: 8px; margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .card { background: white; padding: 15px; border-radius: 8px; border-top: 5px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .chart-box { background: white; padding: 20px; margin-top: 20px; border-radius: 8px; height: 400px; }
        .error-msg { color: red; font-weight: bold; text-align: center; padding: 20px; background: #ffdada; border-radius: 8px; display: none; }
        
        /* Estilo para a nova etiqueta de inspeção */
        .badge {
            background-color: #e2e8f0;
            color: #1a3a5a;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: bold;
            display: inline-block;
            margin-top: 5px;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Diagonal de Manutenção</h1>
        <div id="status-conexao">Conectando ao Google Sheets...</div>
    </header>

    <div id="erro-tela" class="error-msg"></div>

    <div id="cards-container" class="grid"></div>

    <div class="chart-box">
        <canvas id="graficoManutencao"></canvas>
    </div>
</div>

<script>
    // ==========================================
    // LINKS CSV
    var URL_FROTA = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTaUiXIXNFnZGpKFFXY3Agul8ZhqwFZsp6zeR_tzEI3iPDWc4gqMpJA2AmBSQXsSaaNiAyDQbxl54Gt/pub?gid=0&single=true&output=csv';
    var URL_HISTORICO = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTaUiXIXNFnZGpKFFXY3Agul8ZhqwFZsp6zeR_tzEI3iPDWc4gqMpJA2AmBSQXsSaaNiAyDQbxl54Gt/pub?gid=746527009&single=true&output=csv';
    // ==========================================

    function mostrarErro(msg) {
        const div = document.getElementById('erro-tela');
        div.style.display = 'block';
        div.innerHTML = "⚠️ " + msg;
        document.getElementById('status-conexao').innerText = "Falha na carga.";
    }

    function carregarDados() {
        // 1. Carrega a Frota
        Papa.parse(URL_FROTA, {
            download: true,
            header: true,
            complete: function(resFrota) {
                
                // 2. Carrega o Histórico (dentro do sucesso da Frota)
                Papa.parse(URL_HISTORICO, {
                    download: true,
                    header: true,
                    complete: function(resHistorico) {
                        // 3. Processa tudo junto
                        if (resFrota.data.length > 0 && resHistorico.data.length > 0) {
                            processarInterface(resFrota.data, resHistorico.data);
                            document.getElementById('status-conexao').innerText = "Atualizado: " + new Date().toLocaleTimeString();
                        } else {
                            mostrarErro("Dados vazios recebidos das planilhas.");
                        }
                    },
                    error: function(err) { mostrarErro("Erro ao carregar Histórico."); }
                });

            },
            error: function(err) { mostrarErro("Erro ao carregar Frota."); }
        });
    }

    function processarInterface(frota, historico) {
        renderizarCards(frota, historico);
        desenharGrafico(historico);
    }

    function renderizarCards(frota, historico) {
        const lista = document.getElementById('cards-container');
        lista.innerHTML = '';

        // Limpa linhas vazias do histórico e pega a última linha válida (dados mais recentes)
        const histValido = historico.filter(h => h.Data && h.Data.trim() !== '');
        const ultimoRegistro = histValido[histValido.length - 1];

        frota.forEach(aviao => {
            if (!aviao.Matricula) return;

            let horasRestantes = 0;
            
            // LÓGICA NOVA:
            // Tenta pegar o valor diretamente da última linha do histórico usando a matrícula como chave
            if (ultimoRegistro && ultimoRegistro[aviao.Matricula] !== undefined) {
                horasRestantes = parseFloat(ultimoRegistro[aviao.Matricula]);
            } else {
                // Fallback: Se não achar no histórico, calcula pelo método antigo (segurança)
                console.warn(`Aeronave ${aviao.Matricula} não encontrada no histórico recente.`);
                horasRestantes = parseFloat(aviao.ProximaInspecao) - parseFloat(aviao.HorasAtuais);
            }

            // Formata para 1 casa decimal
            const resFormatado = horasRestantes.toFixed(1);
            
            // Garante que TipoInspecao exista, se não, deixa vazio
            const tipoInsp = aviao.TipoInspecao ? aviao.TipoInspecao : '--';

            lista.innerHTML += `
                <div class="card" style="border-top-color: ${horasRestantes < 10 ? '#e74c3c' : '#27ae60'}">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>${aviao.Matricula}</h3>
                        <span class="badge">${tipoInsp}</span>
                    </div>
                    <p>Status: <b>${aviao.Status}</b></p>
                    <p>Restante: <b style="font-size:1.4em">${resFormatado}h</b></p>
                </div>
            `;
        });
    }

    function desenharGrafico(dados) {
        const ctx = document.getElementById('graficoManutencao').getContext('2d');
        const colunas = Object.keys(dados[0]).filter(k => k !== 'Data');
        
        const datasets = colunas.map((m, i) => ({
            label: m,
            data: dados.map(d => ({ x: new Date(d.Data), y: parseFloat(d[m]) })),
            borderColor: ['#1a3a5a', '#27ae60', '#f1c40f', '#e74c3c'][i % 4],
            tension: 0.3
        }));

        new Chart(ctx, {
            type: 'line',
            data: { datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { 
                    x: { 
                        type: 'time', 
                        time: { unit: 'day', displayFormats: { day: 'dd/MM' } },
                        title: { display: true, text: 'Data' }
                    }, 
                    y: { 
                        beginAtZero: false,
                        title: { display: true, text: 'Horas Restantes' }
                    } 
                },
                plugins: {
                    legend: { position: 'top' }
                }
            }
        });
    }

    window.onload = carregarDados;
</script>
</body>
</html>
