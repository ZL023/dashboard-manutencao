<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagonal de Manutenção Aeronáutica</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <style>
        :root {
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --primary: #1a3a5a;
            --success: #27ae60;
            --warning: #f1c40f;
            --danger: #e74c3c;
            --text: #333;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text); 
            margin: 0; 
            padding: 20px; 
        }

        .container { max-width: 1200px; margin: 0 auto; }

        header { 
            text-align: center; 
            padding: 20px 0; 
            background: var(--primary); 
            color: white; 
            border-radius: 12px; 
            margin-bottom: 30px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* Grid de Cards */
        .grid-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border-top: 6px solid #ccc;
            transition: transform 0.2s;
        }
        .card:hover { transform: translateY(-3px); }

        .card-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
        }

        .matricula { font-size: 1.4rem; font-weight: 700; color: var(--primary); }
        
        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            color: white;
        }

        .data-row { 
            display: flex; 
            justify-content: space-between; 
            margin: 8px 0; 
            font-size: 0.9rem; 
            border-bottom: 1px dashed #eee;
            padding-bottom: 4px;
        }

        /* Barra de Progresso */
        .progress-wrapper { margin-top: 15px; text-align: center; }
        .progress-container {
            background: #eee;
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
            margin: 8px 0;
        }
        .progress-fill { height: 100%; width: 0%; transition: width 1s ease-in-out; }
        .hrs-restantes { font-size: 1.2rem; font-weight: 700; }

        /* Área do Gráfico */
        .chart-section {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            height: 450px;
        }

        h2 { margin-top: 0; font-size: 1.2rem; color: var(--primary); }

        /* Cores dinâmicas */
        .bg-success { background-color: var(--success); }
        .bg-warning { background-color: var(--warning); color: #333; }
        .bg-danger { background-color: var(--danger); }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Diagonal de Manutenção</h1>
        <p id="last-update">Carregando dados...</p>
    </header>

    <div id="cards-container" class="grid-cards">
        </div>

    <div class="chart-section">
        <h2>Tendência de Disponibilidade (Últimos 30 dias)</h2>
        <canvas id="canvasGrafico"></canvas>
    </div>
</div>

<script>
    // ==========================================
    // CONFIGURAÇÃO: COLE SEUS LINKS CSV AQUI
    // ==========================================
    const URL_FROTA = 'LINK_VALORES_FROTA'; 
    const URL_HISTORICO = 'LINK_VALORES_HISTORICO';
    // ==========================================

    let chartInstance = null;

    async function fetchData() {
        // Busca dados da Frota
        Papa.parse(URL_FROTA, {
            download: true,
            header: true,
            complete: (results) => {
                renderCards(results.data);
                document.getElementById('last-update').innerText = "Atualizado em: " + new Date().toLocaleString();
            }
        });

        // Busca dados do Histórico
        Papa.parse(URL_HISTORICO, {
            download: true,
            header: true,
            complete: (results) => {
                renderChart(results.data);
            }
        });
    }

    function renderCards(data) {
        const container = document.getElementById('cards-container');
        container.innerHTML = '';

        data.forEach(item => {
            if (!item.Matricula) return;

            const tsn = parseFloat(item.HorasAtuais) || 0;
            const prox = parseFloat(item.ProximaInspecao) || 0;
            const restantes = (prox - tsn).toFixed(1);
            const status = item.Status || 'Indisponível';

            // Lógica de cores
            let cor = 'var(--success)';
            let classe = 'bg-success';

            if (status.toLowerCase().includes('manuten') || status.toLowerCase().includes('aog')) {
                cor = 'var(--danger)';
                classe = 'bg-danger';
            } else if (restantes <= 5) {
                cor = 'var(--danger)';
                classe = 'bg-danger';
            } else if (restantes <= 15) {
                cor = 'var(--warning)';
                classe = 'bg-warning';
            }

            // Cálculo da barra (baseado em ciclo de 50h)
            let pct = (restantes / 50) * 100;
            if (pct > 100) pct = 100;
            if (pct < 0) pct = 0;

            const cardHtml = `
                <div class="card" style="border-top-color: ${cor}">
                    <div class="card-header">
                        <span class="matricula">${item.Matricula}</span>
                        <span class="status-badge ${classe}">${status}</span>
                    </div>
                    <div class="data-row"><span>Horas Totais (TSN):</span> <b>${tsn}h</b></div>
                    <div class="data-row"><span>Próxima Inspeção:</span> <b>${prox}h</b></div>
                    
                    <div class="progress-wrapper">
                        <div class="hrs-restantes" style="color: ${cor}">${restantes}h</div>
                        <small>restantes para manutenção</small>
                        <div class="progress-container">
                            <div class="progress-fill ${classe}" style="width: ${pct}%"></div>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML += cardHtml;
        });
    }

    function renderChart(historyData) {
        if (!historyData || historyData.length === 0) return;

        const ctx = document.getElementById('canvasGrafico').getContext('2d');
        const colunas = Object.keys(historyData[0]).filter(key => key !== 'Data');
        const cores = ['#1a3a5a', '#27ae60', '#f1c40f', '#e74c3c', '#8e44ad', '#2c3e50'];

        const dataLimite = new Date();
        dataLimite.setDate(dataLimite.getDate() - 30);

        const datasets = colunas.map((matricula, index) => {
            const pontos = historyData
                .map(row => {
                    const dataPonto = new Date(row.Data);
                    const valor = parseFloat(row[matricula]);
                    return { x: dataPonto, y: valor };
                })
                .filter(ponto => !isNaN(ponto.y) && ponto.x >= dataLimite)
                .sort((a, b) => a.x - b.x);

            return {
                label: matricula,
                data: pontos,
                borderColor: cores[index % cores.length],
                backgroundColor: cores[index % cores.length],
                borderWidth: 3,
                tension: 0.3,
                pointRadius: 4
            };
        });

        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: { datasets
